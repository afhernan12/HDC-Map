<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
     <title>HDC Map</title>
     <link rel="stylesheet" type="text/css" href="styles.css" />
     
    <!-- Font Library --> 
    <script src="https://use.fontawesome.com/releases/v6.2.0/js/all.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    
     <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <!-- Bootstrap Multiselect CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-multiselect@0.9.15/dist/css/bootstrap-multiselect.css">
    
    <!-- Bootstrap Multiselect JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-multiselect@0.9.15/dist/js/bootstrap-multiselect.min.js"></script>
    
    <!-- RequireJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    
  </head>
  <body onload="initMap()">

	<div id="container">
		<div class="layers">	
			
			<div class="control-group">
				<h2>HDC Map</h2>
			</div>	
			
			<div class="control-group">
				<span class="control-label">Opportunity Zones By Tract</span>
				<label class="switch"> 
				  <input type="checkbox" id="toggleTracts"> 
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">Station Area Overlay (light rail)</span>
				<label class="switch">
				  <input type="checkbox" id="toggleSeattleStationOverlay">
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">Mandatory Housing Affordability Zones</span>
				<label class="switch">
				  <input type="checkbox" id="toggleMHA">
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">Urban Village</span>
				<label class="switch">
				  <input type="checkbox" id="toggleVillage">
				  <span class="slider round"></span> 
				</label>
			</div>
			
			<div class="control-group">
				<span class="control-label">Health Index</span>
				<label class="switch">
				  <input type="checkbox" id="toggleHealth">
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">King County</span>
				<label class="switch">
				  <input type="checkbox" id="toggleKing">
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">Small Fair Market Rent</span>
				<label class="switch">
				  <input type="checkbox" id="toggleFMR">
				  <span class="slider round"></span> 
				</label> 
			</div>
			
			<div class="control-group">
				<span class="control-label">US Small Fair Market Rents</span>
				<label class="switch">
				  <input type="checkbox" id="toggleSAFMR">
				  <span class="slider round"></span> 
				</label>
			</div>
			
			<div class="control-group">
				<select id="sponsors" multiple="multiple">
				    <option value="hdc">Housing Diversity Corp</option>
				    <option value="ozn">OZ Navigator</option>
				    <option value="anew">Anew Apartments</option>
				    <option value="apodments.com">aPodments.com</option>
				</select> 	
			</div>
		</div>	
	
	
		<br/>
		
		<div id="legend" style="display: none; position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc;">
		  <h4>SAFMR Scores</h4>
		  <h6>For One Bedroom</h6>
		  <div><span style="background-color: green; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span> Top 10%</div>
		  <div><span style="background-color: yellow; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span> Top 20%</div>
		  <div><span style="background-color: red; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span> Top 30%</div>
		  <div><span style="background-color: gray; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span> Below 30%</div>
		  <div style="margin-top: 10px;">
		    <div>Fill: MSA Score</div>
		    <div>Border: US Score</div>
		  </div>
		</div>
		
		<div id="map"></div>
   </div>
 
    <script>
      let map;
      let wa_oz_tract_layer;
      let seattle_station_layer;
      let mha_layer;
      let health_layer;
      let village_layer;
      
      let king_county_layer;
      let fmr_layer;
      let zip_codes;
      
      let hdc_properties = [];
      let ozn_properties = [];
      let anew_properties = [];
      let apod_properties = [];
      
      const sponsorMap = new Map([
     	['hdc', hdc_properties],
     	['ozn', ozn_properties],
     	['anew', anew_properties],
     	['apodments.com', apod_properties] 
      ]);
      
      const sponsorColor = {
		  'hdc': '#6E8658',
		  'ozn': '#57473A',
		  'anew': '#BE9A60',
		  'apodments.com':'#73A1B2'
	  }
      
      async function initMap() {
		const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        
        map = new google.maps.Map(document.getElementById('map'), {
          center: new google.maps.LatLng(47.606370, -122.320401), 
          zoom: 10,
          mapId: "4504f8b37365c3d0",
        });
        
        window.AdvancedMarkerElement = AdvancedMarkerElement;
        
        wa_oz_tract_layer = new google.maps.Data();
        seattle_station_layer = new google.maps.Data();
        mha_layer = new google.maps.Data();
        low_income_layer = new google.maps.Data();
        village_layer = new google.maps.Data();
        health_layer = new google.maps.Data();
        king_county_layer = new google.maps.Data();
        fmr_layer = new google.maps.Data();
        zip_codes = new google.maps.Data();
        
        wa_oz_tract_layer.loadGeoJson("wa_oz.geojson");
        seattle_station_layer.loadGeoJson("seattle_station_overlay.txt"); 
        mha_layer.loadGeoJson("MHA_zone.geojson");
        village_layer.loadGeoJson("urban_center.geojson");
       	health_layer.loadGeoJson("health_index2.geojson");
       	king_county_layer.loadGeoJson("king_county_housing.geojson");
       	fmr_layer.loadGeoJson("fmr_vps.geojson");
       	zip_codes.loadGeoJson("zip_code_safmr.geojson");
       	
       	
       	infoWindow = new google.maps.InfoWindow();
        
        //set up event listeners
        document.getElementById('toggleTracts').addEventListener('change', toggleTracts);
        document.getElementById('toggleSeattleStationOverlay').addEventListener('change', toggleSeattleStationOverlay);
        document.getElementById('toggleMHA').addEventListener('change', toggleMHA);
        document.getElementById('toggleVillage').addEventListener('change', toggleVillage);
        document.getElementById('toggleHealth').addEventListener('change', toggleHealth);
        document.getElementById('toggleKing').addEventListener('change', toggleKing);
        document.getElementById('toggleFMR').addEventListener('change', toggleFMR);
        document.getElementById('toggleSAFMR').addEventListener('change', toggleSAFMR);
      }
      
      async function toggleSAFMR(){
		  const legendElement = document.getElementById('legend');
		   if (document.getElementById('toggleSAFMR').checked) {
		    zip_codes.setStyle(function(feature) {
		      const msa_score = feature.getProperty('score');
		      const us_score = feature.getProperty('us_score');
		      
			  // Determine fill color based on MSA score
			  let fillColor;
			  if (msa_score >= 0.9) {
				  fillColor = 'green';
			  } else if (msa_score >= 0.8) {
			      fillColor = 'yellow';
			  } else if (msa_score >= 0.7) {
			      fillColor = 'red';
			  } else {
			      fillColor = 'gray';
			  }
			
		      // Determine stroke color based on US score
		      let strokeColor;
		      if (us_score >= 0.9) {
		        strokeColor = 'green';
		      } else if (us_score >= 0.8) {
		        strokeColor = 'yellow';
		      } else if (us_score >= 0.7) {
		        strokeColor = 'red';
		      } else {
		        strokeColor = 'gray';
		      }
		      
		      // Determine z-index based on stroke color priority
		      let zIndex;
		      switch (strokeColor) {
		        case 'green':
		          zIndex = 4;
		          break;
		        case 'yellow':
		          zIndex = 3;
		          break;
		        case 'red':
		          zIndex = 2;
		          break;
		        default:
		          zIndex = 1;
		      }
			
		      return {
		        fillColor: fillColor,
		        fillOpacity: 0.7,
		        strokeColor: strokeColor,
		        strokeOpacity: 1,
		        strokeWeight: 2,
		        zIndex: zIndex
		      };
		    });
	
		    zip_codes.addListener('click', handleMouseClickSAFMR);
		    zip_codes.setMap(map);
		    legendElement.style.display = 'block'; // Show the legend
		  } else {
		    zip_codes.setMap(null);
		    legendElement.style.display = 'none'; // Show the legend
		  }
	  }
     
      
      function toggleTracts(){
		if (document.getElementById('toggleTracts').checked){
			wa_oz_tract_layer.setStyle({
			    fillColor: 'green',
			    strokeColor: '#000',
			    strokeOpacity: 1,
			    strokeWeight: 1
			 });
			 
			 wa_oz_tract_layer.setMap(map);	
		} else {
			wa_oz_tract_layer.setMap(null);
		}
	  }
	  
	  
	  function toggleSeattleStationOverlay(){
		  if (document.getElementById('toggleSeattleStationOverlay').checked){
			   seattle_station_layer.setStyle({
				    fillColor: 'purple',
				    strokeColor: '#000',
				    strokeOpacity: 1,
				    strokeWeight: 1
			   });
				
			   seattle_station_layer.setMap(map);  
		  } else {
			  seattle_station_layer.setMap(null);
		  }
	  }
	  
	   function toggleMHA(){
		if (document.getElementById('toggleMHA').checked){			
			mha_layer.setStyle({
			    fillColor: 'blue',
			    strokeColor: '#000',
			    strokeOpacity: 1,
			    strokeWeight: 1
			 });
			 
			 mha_layer.setMap(map);	
		} else {
			mha_layer.setMap(null);
		}
	  }
	  
	  function toggleVillage(){
		  if (document.getElementById('toggleVillage').checked){
			  console.log("in toogleVillage");
			  village_layer.setStyle({
			    fillColor: 'yellow',
			    strokeColor: '#000',
			    strokeOpacity: 1,
			    strokeWeight: 1
			 });
			 
			 village_layer.setMap(map);
		  } else {
			  village_layer.setMap(null);
		  }
	  }
	  
	 async function toggleHealth(){
		if (document.getElementById('toggleHealth').checked){		
			  health_layer.setStyle(function(feature) {
				var healthScore = feature.getProperty('HEALTH_DISADV_SCORE');  
				console.log(feature);
				console.log("health score: ", healthScore);
				return {
					fillColor: 'red',
					fillOpacity: healthScore,
				    strokeColor: '#000',
				    strokeOpacity: 1,
				    strokeWeight: 0.5
				};
			 });
			 
			 health_layer.addListener('mouseover', handleMouseOver);
			 health_layer.addListener('mouseout', handleMouseOut);
			 
			 health_layer.setMap(map);
		} else {
			health_layer.setMap(null);
		}
	  }
	  
	  async function toggleKing(){
		if (document.getElementById('toggleKing').checked){		
			  king_county_layer.setStyle(function(feature) {
				console.log(feature);
				
				var income = feature.getProperty('income');
				var rent = feature.getProperty('median_rent');
				var renter_pct = feature.getProperty('rental_pct');
				
				if (rent < 0) {
					console.log("nan rent", rent);
					rent = 1000;
					console.log("non nan rent", rent);
				}
				
				var burdened = rent * 12 / income;

				return {
					fillColor: 'purple',
					fillOpacity: renter_pct,
				    strokeColor: '#000',
				    strokeOpacity: 1,
				    strokeWeight: .5
				};     
			 });
			 
			 king_county_layer.addListener('click', handleMouseClickKing);
			 
			 king_county_layer.setMap(map);
		} else {
			king_county_layer.setMap(null);
		}
	  }
	  
	  async function toggleFMR(){
		  if (document.getElementById('toggleFMR').checked){
			  let min = Infinity;
			  let max = -Infinity;
			  
			  fmr_layer.forEach((feature) => {
				  const fmr = feature.getProperty('One-Bedroom');
				  if (fmr < min) min = fmr;
				  if (fmr > max) max = fmr;
			  });
			  
			  		
			  fmr_layer.setStyle(function(feature) {
				var zip = feature.getProperty('zip_code');  
				console.log(feature);
				
				const fmr = feature.getProperty('One-Bedroom');
				const normalizedFMR = (fmr - min) /(max - min);
				
				// Interpolate between red (low FMR) and green (high FMR)
				let red, green;
		        if (normalizedFMR < 0.5) {
			        // Red to Yellow
			        red = 255;
			        green = Math.round(255 * (normalizedFMR * 2));
		        } else {
			        // Yellow to Green
			        red = Math.round(255 * ((1 - normalizedFMR) * 2));
			        green = 255;
		        }
				
				const color = `rgb(${red}, ${green}, 0)`;
				console.log(color);
		
				return {
					fillColor: color,
					fillOpacity: .7,
				    strokeColor: '#000',
				    strokeOpacity: 1,
				    strokeWeight: .5
				};
			 });
			 
			 fmr_layer.addListener('click', handleMouseClickFMR);
			 
			 fmr_layer.setMap(map);
		} else {
			 fmr_layer.setMap(null);
		}
		  
	  }
	  
	  function handleMouseClickKing(event){
		  console.log("in king mouse click");
	       var content = '<div class="info-window">' +
	          '<h4> Income: ' + event.feature.getProperty('income') + '</h4>' +
	          '<h3> Tract: ' + event.feature.getProperty('tract') + '</h3>' +
	          '<p>american_indian: ' + event.feature.getProperty('american_indian') + '</p>' +
	          '<p>asian: ' + event.feature.getProperty('asian') + '</p>' +
	          '<p>black: ' + event.feature.getProperty('black') + '</p>' +
	          '<p>hispanic: ' + event.feature.getProperty('hispanic') + '</p>' +
	          '<p>white: ' + event.feature.getProperty('white') + '</p>' +
	          '<p>median_rent ' + event.feature.getProperty('median_rent') + '</p>' +
	          '<p>rental_units: ' + event.feature.getProperty('rental_units') + '</p>' +
	          '<p>total_units: ' + event.feature.getProperty('total_units') + '</p>' +
	          '<p>rental units / total units: ' + event.feature.getProperty('rental_pct').toFixed(3) + '</p>' +
	          '</div>';
	          
	          infoWindow.setContent(content);
	          infoWindow.setPosition(event.latLng);
	          
	          infoWindow.open(map);
	  }
	  
	  function handleMouseOver(event){
		  console.log("in mouse click");
		  
		  var content = '<div class="info-window">' +
	          '<h4> Census Tract: ' + event.feature.getProperty('GEOID') + '</h4>' +
	          '<p>Health Disadvantage Score: ' + event.feature.getProperty('HEALTH_DISADV_SCORE').toFixed(3) + '</p>' +
	          '<p>Health Disadvantage Quntile: ' + event.feature.getProperty('HEALTH_DISADV_QUINTILE') + '</p>' +
	          '<p>Life Expectancy: ' + event.feature.getProperty('LIFE_EXPECTANCY_AT_BIRTH').toFixed(1) + ' years</p>' +
	          '<p>Adults with Obesity: ' + (event.feature.getProperty('PCT_ADULT_WITH_OBESITY') * 100).toFixed(1) + '%</p>' +
	          '<p>Adults with Diabetes: ' + (event.feature.getProperty('PCT_ADULT_WITH_DIABETES') * 100).toFixed(1) + '%</p>' +
	          '<p>Adults with Asthma: ' + (event.feature.getProperty('PCT_ADULT_WITH_ASTHMA') * 100).toFixed(1) + '%</p>' +
	          '</div>';
	          
	          infoWindow.setContent(content);
	          infoWindow.setPosition(event.latLng);
	          
	          infoWindow.open(map);
	  }
	  
	  function handleMouseClickFMR(event){
		  console.log("in mouse click");
		  
		  var tier = event.feature.getProperty('tier');
		  if (tier != null){
			  tier = tier.toString();
			  if (tier == '4') tier = "VPS";
		  } 
		  
		  var content = '<div class="info-window">' +
	          '<h4>Zip Code: ' + event.feature.getProperty('zip_code') + '</h4>' +
	          '<p>Efficiency: ' + event.feature.getProperty('Efficiency') + '</p>' +
	          '<p>One-Bedroom: ' + event.feature.getProperty('One-Bedroom') + '</p>' +
	          '<p>Two-Bedroom: ' + event.feature.getProperty('Two-Bedroom') + ' </p>' +
	          '<p>Three-Bedroom: ' + event.feature.getProperty('Three-Bedroom') + '</p>' +
	          '<p>Four-Bedroom: ' + event.feature.getProperty('Four-Bedroom') + '</p>' +
	          '<p>tier: ' +  tier + '</p>' +
	          '<p>vps_0: ' + event.feature.getProperty('vps_0') + '</p>' +
	          '<p>vps_1: ' + event.feature.getProperty('vps_1') + '</p>' +
	          '<p>vps_2: ' + event.feature.getProperty('vps_2') + '</p>' +
	          '<p>vps_4: ' + event.feature.getProperty('vps_4') + '</p>' +
	          '</div>';
	          
	          infoWindow.setContent(content);
	          infoWindow.setPosition(event.latLng);
	          
	          infoWindow.open(map);
	  }
	  
	  function handleMouseClickSAFMR(event){		  
		  var content = '<div class="info-window">' +
	          '<h4>' + event.feature.getProperty('area_name') + '</h4>' +
	          '<h4>Zip Code: ' + event.feature.getProperty('zip_code') + '</h4>' +
	          '<p>Efficiency: ' + event.feature.getProperty('Efficiency') + '</p>' +
	          '<p>One-Bedroom: ' + event.feature.getProperty('One-Bedroom') + '</p>' +
	          '<p>Two-Bedroom: ' + event.feature.getProperty('Two-Bedroom') + ' </p>' +
	          '<p>Three-Bedroom: ' + event.feature.getProperty('Three-Bedroom') + '</p>' +
	          '<p>Four-Bedroom: ' + event.feature.getProperty('Four-Bedroom') + '</p>' +
	          '<p>Min-One-Bed: ' + event.feature.getProperty('min_oneBed') + '</p>' +
	          '<p>Max-One-Bed: ' + event.feature.getProperty('max_oneBed') + '</p>' +
	          '<p>MSA Score: ' + event.feature.getProperty('score') + '</p>' +
	          '<p>US Score: ' + event.feature.getProperty('us_score') + '</p>' +
	          '<p>Year: ' + event.feature.getProperty('year') + '</p>' +
	          '</div>';
	          
	          infoWindow.setContent(content);
	          infoWindow.setPosition(event.latLng);
	          
	          infoWindow.open(map);
	  }
	  
	  function handleMouseOut(event){  
	  	  infoWindow.close();
	  }
	   
	  function escapeHtml(unsafe) {
		  return unsafe 
		  .replace(/&/g, "&amp;")
		  .replace(/</g, "&lt;")
		  .replace(/>/g, "&gt;")
		  .replace(/"/g, "&quot;")
		  .replace(/'/g, "&#039;");
	  }
	  
	  function toggleHighlight(markerView, property) {
		  if (markerView.content.classList.contains("highlight")) {
		    markerView.content.classList.remove("highlight");
		    markerView.zIndex = null;
		  } else {
		    markerView.content.classList.add("highlight");
		    markerView.zIndex = 1;
		  }
	  }
	  		
		$(document).ready(function() {
	        $('#sponsors').multiselect({
	            includeSelectAllOption: true,
	            nonSelectedText: 'Select Properites',
	            
	            onChange: function(option, checked) {
		            // Get the value of the changed option
		            var value = $(option).val();
		            
		            // Check if the option was selected or deselected
		            if (checked) {
		                console.log('Option ' + value + ' was selected');
		                // Call function to show properties for this sponsor
		                showProperties(value);
		            } else {
		                console.log('Option ' + value + ' was deselected');
		                // Call function to hide properties for this sponsor
		                hideProperties(value);
		            }
	        	},
		        onSelectAll: function() {
		            console.log('All options were selected');
		            // Call function to show all properties
		            showAllProperties();
		        },
		        onDeselectAll: function() {
		            console.log('All options were deselected');
		            // Call function to hide all properties
		            hideAllProperties();
		        }
	        });	        
    	});
    	
    	
    	async function showProperties(sponsor) {
		    if (!map) return;
		    let properties = sponsorMap.get(sponsor);
		    if (properties.length === 0) {
		        await fetchAndCreateMarkers(sponsor);
		    }
		    properties = sponsorMap.get(sponsor);
		    properties.forEach(marker => marker.setMap(map));
		}
		
		function hideProperties(sponsor) {
		    const properties = sponsorMap.get(sponsor);
		    properties.forEach(marker => marker.setMap(null));
		}
		    	
    	function showAllProperties() {
		    sponsorMap.forEach((properties, sponsor) => {
		        showProperties(sponsor);
		    });
		}
		
		function hideAllProperties() {
		    sponsorMap.forEach((properties) => {
		        properties.forEach(marker => marker.setMap(null));
		    });
		}
    	
    	
    	async function fetchAndCreateMarkers(sponsor) {
		    try {
		        const response = await fetch("/HDC_Map/getDataServlet");
		        const data = await response.json();
		        
		        data.forEach(item => {
		            if (item.owner.toLowerCase() === sponsor) {
		                const marker = new window.AdvancedMarkerElement({
		                    map: map,
		                    content: buildContent(item),
		                    position: {
		                        lat: parseFloat(item.lat),
		                        lng: parseFloat(item.lng)
		                    },
		                    title: item.owner,
		                });
		                
		                marker.addListener("click", () => {
		                    toggleHighlight(marker, item);
		                });
		                
		                sponsorMap.get(sponsor).push(marker);
		            }
		        });
		    } catch (error) {
		        console.error("Error fetching property data:", error);
		    }
		 }
		 
		function buildContent(property) {
		  const content = document.createElement("div");
		  const owner = property.owner.toLowerCase();
		  const color = sponsorColor[owner];
		
		  content.classList.add("property");
		  content.innerHTML = `
		    <div class="icon">
		        <i aria-hidden="true" class="fa fa-icon fa-building" title="building" style="color: ${color};"></i>
		        <span class="fa-sr-only">building</span>
		    </div>
		    <div class="details">
		        <div class="owner">${property.owner}: ${property.name}</div>
		        <div class="address">${property.address}</div>
		        <div class="features">
		        <div>
		            <i aria-hidden="true" class="fa-solid fa-door-open" title="room"></i>
		            <span class="fa-sr-only">room</span>
		            <span>${property.units}</span>
		        </div>
		        <div>
		            <i aria-hidden="true" class="fa-solid fa-person-walking" title="walk_score"></i>
		            <span class="fa-sr-only">Walk Score</span>
		            <span>${property.walk_score}/100</span>
		        </div>
		        <div>
		            <i aria-hidden="true" class="fa fa-ruler fa-lg size" title="size"></i>
		            <span class="fa-sr-only">size</span>
		            <span>${property.bld_size} ft<sup>2</sup></span>
		        </div>
		        </div>
		    </div>
		    `;
		  return content;
		}
    </script>
        
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlYMTJTtHI0tE4RnaKS54xv0Qf8kBvzKE&libraries=visualization&callback=initMap">
    </script>
    
    
  </body>
</html>

